C51 COMPILER V8.02   LCD1602P1KEY                                                          05/23/2011 00:24:45 PAGE 1   


C51 COMPILER V8.02, COMPILATION OF MODULE LCD1602P1KEY
OBJECT MODULE PLACED IN LCD1602P1Key.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE LCD1602P1Key.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          /********************************************************************************
   3          *  描述:                                                                       *    
   4          *        矩阵键盘1602液晶显示键值                                              *    
   5          *   连接方法：JP8（P1） 与JP4（矩阵键盘接口） 连接                             *    
   6          *         矩阵键盘定义：                                                       *
   7          *         P1.1-P1.4为列线,P1.4-P1.7为行线                                      *    
   8          *         喇叭接P1.5口  矩阵键盘P1口，                                         *    
   9          *  注意：请将JP165短路冒断开                                                   *                          
             -  
  10          ********************************************************************************/
  11          
  12          
  13          #include <reg51.h>
  14          #include <intrins.h>
  15                                  
  16          #define uchar unsigned char
  17          #define uint  unsigned int
  18          
  19          uchar  dis_buf;            //显示缓存
  20          uchar  temp;
  21          uchar  key;                //键顺序吗
  22          void delay0(uchar x);      //x*0.14MS
  23          
  24          sbit LCD_RW = P2^4;
  25          sbit LCD_RS = P2^3;             
  26          sbit LCD_EN = P2^5;
  27          
  28          uchar cdis1[16] = {"  KEY NUMBER   "};
  29          uchar cdis2[16] = {"  KEY-CODE:   H "};
  30          
  31          #define delayNOP(); {_nop_();_nop_();_nop_();_nop_();};
  32          
  33          /*************************************************************/
  34          /*                                                           */
  35          /* 延时子程序                                                */
  36          /*                                                           */
  37          /*************************************************************/
  38          
  39          void  delay(uchar x)
  40          { uchar j;
  41   1          while((x--)!=0)
  42   1          { for(j=0;j<125;j++)
  43   2               {;}
  44   2          }
  45   1      }
  46          
  47          /*************************************************************/
  48          /*                                                           */
  49          /*检查LCD忙状态                                              */
  50          /*lcd_busy为1时，忙，等待。lcd-busy为0时,闲，可写指令与数据  */
  51          /*                                                           */
  52          /*************************************************************/ 
  53          
  54          bit lcd_busy()
C51 COMPILER V8.02   LCD1602P1KEY                                                          05/23/2011 00:24:45 PAGE 2   

  55           {                          
  56   1          bit result;
  57   1          LCD_RS = 0;
  58   1          LCD_RW = 1;
  59   1          LCD_EN = 1;
  60   1          delayNOP();
  61   1          result = (bit)(P0&0x01);
  62   1          LCD_EN = 0;
  63   1          return(result); 
  64   1       }
  65          
  66          /*******************************************************************/
  67          /*                                                                 */
  68          /*写指令数据到LCD                                                  */
  69          /*RS=L，RW=L，E=高脉冲，D0-D7=指令码。                             */
  70          /*                                                                 */
  71          /*******************************************************************/
  72          
  73          void lcd_wcmd(uchar cmd)
  74          
  75          {                          
  76   1         while(lcd_busy());
  77   1          LCD_RS = 0;
  78   1          LCD_RW = 0;
  79   1          LCD_EN = 0;
  80   1          _nop_();
  81   1          _nop_(); 
  82   1          cmd = ((cmd&0x01)<<7)|((cmd&0x02)<<5)|((cmd&0x04)<<3)|((cmd&0x08)<<1)|((cmd&0x10)>>1)|((cmd&0x20)>>3)|
             -((cmd&0x40)>>5)|((cmd&0x80)>>7);
  83   1              P0 =  cmd;
  84   1          delayNOP();
  85   1          LCD_EN = 1;
  86   1          delayNOP();
  87   1          LCD_EN = 0;  
  88   1      }
  89          
  90          /*******************************************************************/
  91          /*                                                                 */
  92          /*写显示数据到LCD                                                  */
  93          /*RS=H，RW=L，E=高脉冲，D0-D7=数据。                               */
  94          /*                                                                 */
  95          /*******************************************************************/
  96          
  97          void lcd_wdat(uchar dat)
  98          {                          
  99   1         while(lcd_busy());
 100   1          LCD_RS = 1;
 101   1          LCD_RW = 0;
 102   1          LCD_EN = 0;
 103   1              dat = ((dat&0x01)<<7)|((dat&0x02)<<5)|((dat&0x04)<<3)|((dat&0x08)<<1)|((dat&0x10)>>1)|((dat&0x20)>>3)|((d
             -at&0x40)>>5)|((dat&0x80)>>7);
 104   1          P0 = dat;
 105   1          delayNOP();
 106   1          LCD_EN = 1;
 107   1          delayNOP();
 108   1          LCD_EN = 0; 
 109   1      }
 110          
 111          /*************************************************************/
 112          /*                                                           */
 113          /*  LCD初始化设定                                            */
 114          /*                                                           */
C51 COMPILER V8.02   LCD1602P1KEY                                                          05/23/2011 00:24:45 PAGE 3   

 115          /*************************************************************/
 116          
 117          void lcd_init()
 118          { 
 119   1          delay(15);                   
 120   1          lcd_wcmd(0x38);      //16*2显示，5*7点阵，8位数据
 121   1          delay(5);
 122   1          lcd_wcmd(0x38);         
 123   1          delay(5);
 124   1          lcd_wcmd(0x38);         
 125   1          delay(5);
 126   1      
 127   1          lcd_wcmd(0x0c);      //显示开，关光标
 128   1          delay(5);
 129   1          lcd_wcmd(0x06);      //移动光标
 130   1          delay(5);
 131   1          lcd_wcmd(0x01);      //清除LCD的显示内容
 132   1          delay(5);
 133   1      }
 134          
 135          /*************************************************************/
 136          /*                                                           */
 137          /*  设定显示位置                                             */
 138          /*                                                           */
 139          /*************************************************************/
 140          
 141          void lcd_pos(uchar pos)
 142          {                          
 143   1        lcd_wcmd(pos | 0x80);  //数据指针=80+地址变量
 144   1      }
 145          
 146          /*************************************************************/
 147          /*                                                           */
 148          /* 键扫描子程序  (4*3 的矩阵) P1.4 P1.5 P1.6 P1.7为行        */
 149          /*                                                        P1.1 P1.2 P1.3为列             */
 150          /*                                                                                       */
 151          /*************************************************************/
 152          
 153           void  keyscan(void)
 154           {      temp = 0;
 155   1          P1=0xF0;                 //高四位输入   行为高电平  列为低电平
 156   1          delay(1);
 157   1              temp=P1;                 //读P1口 
 158   1          temp=temp&0xF0;                      //屏蔽低四位
 159   1          temp=~((temp>>4)|0xF0);       
 160   1          if(temp==1)   // p1.4 被拉低
 161   1              key=0;
 162   1          else if(temp==2)   // p1.5 被拉低
 163   1              key=1;
 164   1          else if(temp==4)   // p1.6 被拉低
 165   1              key=2;
 166   1          else if(temp==8)   // p1.7 被拉低
 167   1               key=3;
 168   1          else
 169   1              key=16;
 170   1              
 171   1          P1=0x0F;                //低四位输入  列为高电平 行为低电平
 172   1          delay(1);
 173   1              temp=P1;                //读P1口       
 174   1          temp=temp&0x0F;
 175   1          temp=~(temp|0xF0);
 176   1          if(temp==2)            // p1.1  被拉低
C51 COMPILER V8.02   LCD1602P1KEY                                                          05/23/2011 00:24:45 PAGE 4   

 177   1              key=key+0;
 178   1          else if(temp==4)   // p1.2  被拉低
 179   1              key=key+4;
 180   1          else if(temp==8)    // p1.3  被拉低
 181   1              key=key+8;
 182   1          else
 183   1              key=16;  
 184   1              
 185   1           dis_buf = key;                  //键值入显示缓存
 186   1           dis_buf = dis_buf & 0x0f;
 187   1       
 188   1               if(dis_buf>9)               //转换为ASCII码
 189   1            dis_buf = dis_buf+0x37;
 190   1           else
 191   1                dis_buf = dis_buf+0x30;
 192   1       }
 193          
 194          /*************************************************************/
 195          /*                                                           */
 196          /*判断键是否按下                                             */
 197          /*                                                           */
 198          /*************************************************************/
 199          
 200           void  keydown(void)
 201           {  
 202   1              P1=0xF0;
 203   1              if(P1!=0xF0)  //判断按键是否按下 如果按钮按下 会拉低P1其中的一个端口
 204   1              {
 205   2                keyscan();
 206   2          }
 207   1       }
 208          
 209          
 210          /*************************************************************/
 211          /*                                                           */
 212          /* 主程序                                                    */
 213          /*                                                           */
 214          /*************************************************************/ 
 215          main()
 216           {
 217   1          uchar m;
 218   1          P0=0xFF;                    //置P0口
 219   1          P1=0xFF;                    //置P1口  
 220   1          delay(10);                 //延时
 221   1          lcd_init();                //初始化LCD             
 222   1              
 223   1          lcd_pos(0);                //设置显示位置为第一行的第1个字符
 224   1           m = 0;
 225   1          while(cdis1[m] != '\0')
 226   1           {                         //显示字符
 227   2             lcd_wdat(cdis1[m]);
 228   2             m++;
 229   2           }
 230   1      
 231   1          lcd_pos(0x40);             //设置显示位置为第二行第1个字符
 232   1           m = 0;
 233   1          while(cdis2[m] != '\0')
 234   1           {
 235   2             lcd_wdat(cdis2[m]);      //显示字符
 236   2             m++;
 237   2           }       
 238   1                dis_buf = 0x2d;          //显示字符"-"
C51 COMPILER V8.02   LCD1602P1KEY                                                          05/23/2011 00:24:45 PAGE 5   

 239   1      
 240   1          while(1)
 241   1          { 
 242   2             keydown();
 243   2                 lcd_pos(0x4c);             
 244   2             lcd_wdat(dis_buf);        //第一位数显示   
 245   2          }
 246   1        }   
 247          
 248          /************************************************************/  
 249          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    529    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     35    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
